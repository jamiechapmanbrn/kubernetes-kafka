apiVersion: apps/v1beta2
kind: Deployment
metadata:
  name: replicated-partitions
  namespace: test-kafka
spec:
  replicas: 1
  selector:
    matchLabels:
      test-type: readiness
      test-target: under-replicated-partitions
  template:
    metadata:
      labels:
        test-type: readiness
        test-target: under-replicated-partitions
    spec:
      containers:
      - name: kafka
        image: solsson/kafka:1.0.0@sha256:17fdf1637426f45c93c65826670542e36b9f3394ede1cb61885c6a4befa8f72d
        command:
        - tail
        - --follow
        - --lines=0
        - NOTICE
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - >
              echo "### $(date -Ins -u) ###" >> NOTICE
              &
              [
              $(
              ./bin/kafka-topics.sh
              --zookeeper zookeeper.kafka:2181
              --describe
              --under-replicated-partitions
              |
              tee -a NOTICE
              |
              wc -l
              )
              -eq
              0
              ]
          periodSeconds: 30
          timeoutSeconds: 29
        livenessProbe:
          # log file has been modified within the readiness probe period
          exec:
            command:
            - /bin/sh
            - -c
            - >
              [
              $(( `date +%s` - `stat -L --format %Y NOTICE` ))
              -le
              60
              ]
              &
              echo "ok at $(date -Ins -u)" >> NOTICE
